#!/bin/bash

source /winattacklab/.deploy
source /winattacklab/.destroy
source /winattacklab/proxy.env

cd /winattacklab/

echo "`date`: Deployment Manager Version 2021-04-16-R104"
sleep 2


echo "`date`: Deployment Manager Version 2021-04-16-R104"
sleep 2


case "$DEPLOYED" in
        init)
            echo "`date`: terraform deploy not yet startet - cannot destroy"
            echo "`date`: terraform deploy not yet startet - cannot destroy" >> /winattacklab/logs/terraform-destroy.log
            ;;

        deploying)
            echo "`date`: terraform deploy currently running - cannot destroy"
            echo "`date`: terraform deploy currently running - cannot destroy" >> /winattacklab/logs/terraform-destroy.log

            echo "====== Azure Resource Group ====="                                                                                                    
	    terraform state show 'azurerm_resource_group.winattacklabgroup' |grep id  | cut -d'/' -f5- | cut -d '"' -f1
            echo "================================="   
            sleep 3 
            ;;

        finished)
	    echo "`date`: terraform deployment will now being destroyed"
	    echo "`date`: terraform deployment will now being destroyed" >> /winattacklab/logs/terraform-destroy.log
            case "$DESTROYED" in
                init)
                    rm /winattacklab/terraform.start
                    rm /winattacklab/terraform.end
		    echo "`date`: destroy clicked in DM Web UI" >> /tmp/terraform.destroy.cron
		    echo "`date`: terraform deploy has been executed on `date`" > /tmp/start-stop.log

                    echo "DESTROYED=\"running\"" > /winattacklab/.destroy
                    echo "terraform destroy --auto-approve"
                    echo "please wait 60 seconds until the output below appears" 
                    echo "`date`: terraform destroy --auto-approve started" >> /winattacklab/logs/terraform-status.log
                    echo "`date`: terraform destroy --auto-approve started" >> /winattacklab/logs/terraform-destroy.log
                    echo "`date`: terraform destroy log" >> /winattacklab/logs/terraform-destroy.log
                    terraform destroy -no-color -auto-approve -compact-warnings 2>&1 | egrep -v '\$PlainPassword =|\$labdcadminpw =|\$password =' | tee -a /winattacklab/logs/terraform-destroy.log
                    echo "`date`: terraform destroy --auto-approve finished" >> /winattacklab/logs/terraform-status.log
                    ;;
                running)
                    ps -ef|grep "/usr/bin/terraform destroy"|grep -v grep > /dev/null
                    RESULT=$?
                    if [ $RESULT -eq 0 ]; then
                        echo "`date`: terraform destroy is still running" 
                        echo "`date`: terraform destroy was executed on: `cat /tmp/start-stop.log`" 
                        echo "`date`: terraform destroy is still running" >> /winattacklab/logs/terraform-destroy.log
                    else
                        echo "`date`: terraform destroy was executed on: `cat /tmp/start-stop.log` but not finished yet" 
                        echo "`date`: terraform destroy was executed on: `cat /tmp/start-stop.log` but not finished yet" >> /winattacklab/logs/terraform-destroy.log
			terraform state show 'azurerm_resource_group.winattacklabgroup' >> /winattacklab/logs/terraform-destroy.log
			R1=$?
			if [ $R1 -eq 0 ]; then
				echo "`date`: destroy was not yet successul: infastructure still running"
				echo "`date`: destroy was not yet successul: infrastructure still running" >> /winattacklab/logs/terraform-destroy.log
				echo "`date`: running terraform destry again" >> /winattacklab/logs/terraform-destroy.log
				terraform destroy -no-color --auto-approve 2>&1 | egrep -v '\$PlainPassword =|\$labdcadminpw =|\$password =' >> /winattacklab/logs/terraform-destroy.log
			else
				echo "`date`: infrastructure is fully down"
				echo "`date`: infrastructure is fully down" >>  /winattacklab/logs/terraform-destroy.log
				echo "DESTROYED=\"finished\"" > /winattacklab/.destroy
				echo "DEPLOYED=\"init\"" > /winattacklab/.deploy
			fi 

                    fi

		    echo "`date`: opening destroy log"
                    sleep 5
                    tail -n +0 -f /winattacklab/logs/terraform-destroy.log
                    ;;
                finished)
                    echo "`date`: terraform destroy was executed on: `cat /tmp/start-stop.log`" 
                    echo "terraform destroy has been finished"
                    echo "terraform destroy has been finished" >> /winattacklab/logs/terraform-destroy.log
		    echo "`date`: opening destroy log"
                    sleep 5
                    tail -500 /winattacklab/logs/terraform-destroy.log
                    echo "terraform destroy has been finished"
                    ;;
                *)
                    exit 1
                    ;;
	        esac
            ;;

        *)
            exit 1
            ;;

esac


